---
title: "HCM_Project"
author: "Suraj Gurung"
date: "2023-11-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

1. CE Design

```{r}
#install.packages("rmarkdown", dependencies=TRUE)
library(here)
here()

rm(list = ls()) # Clear space in R environment

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  DoE.base, # The package for orthogonal arrays and factorial designs
  DoE.wrapper, # The package for fractional factorial design
  RcmdrPlugin.DoE, # A graphical user interface for the package DOE.base
  corrplot # The package for creating correlation plot
)
      
```

2. Full Factorial Design
Price- 4 levels: 10.99, 13.99, 16.99, 19.99
Calorie - 4 levels: 1320 Cal, 1520 Cal, 1720 Cal, 1920 Cal
Protein Source - 3 levels: Regular Beef, Plant based beef, USDA Certified low carbon beef
Food Outlet - 3 levels: Home Kitchen, Chain Restaurant and Local Restaurant

2.1 Generate the Full fcatorial design

```{r}
# Conduct the full factorial design and save the design in an object named "Design.1"
Design.1 <- fac.design(
  
  # The experiment has 4 factors
  nfactors = 4, 
  
  # When designing experiment, we do not need to replicate many times
  replications = 1, 
  
  # Since we do not conduct replication in experiment design, the argument is 
  # irrelevant and we set up to FALSE
  repeat.only = FALSE, 
  
  # The experiment is not need to be subdivided
  blocks = 1,
  
  # The experiment design need to be randomized
  randomize = TRUE, 
  
  # Set seed number to be a random number. It guarantees that 
  # this piece of code gives you the same results no matter when and where you excute it
  seed = 28472, 
  
  # Set the number levels included in each factor. 
  # Price has 4 levels, Calorie has 4 levels, Protein Source has 3 levels, Food Outlet has 3 levels
  nlevels=c(4,4,3,3), 
  
  factor.names=list(
    Price=c(1,2,3,4), # The levels of factor Price are 1, 2, 3, and 4
    Cal=c(1,2,3,4), # The levels of factor Calorie are 1, 2, 3 and 4
    Protein=c(1,2,3), # The levels of factor Protein are 1, 2, and 3
    Outlet=c(1,2,3)# The levels of factor HACCP are 1, 2, and 3
  ) 
)

# Show the design result by calling the object name "Design.1"
Design.1 
```

2.2 Evaluate the full factorial design 

```{r}
# Change factor variables to numerical variables
Design.1.num <- sapply(Design.1, as.numeric)

# Calculate the correlation matrix among different factors
cor(Design.1.num)
```

3. Calulate the fractional factorial design

min no. of choice = (sum(levels))-N+1= 14-4+1= 11
- Done with the package DOE.wrapper

```{r}
# Conduct a fractional factorial design with 8 choice profiles and 
# save the design in an object named "Design.1.D"
Design.1.D <- Dopt.design(
  
  # The number of choice profiles need to be generated is 8
  11, ## Minim number needed
  
  # Choose profiles from the candidate profiles generated by the full factorial design
  data = Design.1, 
  
  # The model is a main effect model without interaction terms
  formula = "~Price + Cal + Protein + Outlet", 
  
  # The number of independent repeats of the design optimization is 100. 
  # Increasing the number may improve design optimum, but will increase search time
  nRepeat = 100, 
  
  # The design is randomized
  randomize= TRUE ,
  
  # Set seed number to be a random number. It guarantees that 
  # this piece of code gives you the same results no matter when and where you excute it
  seed= 19567 
)

# Show the design results by calling the object name "Design.1.D"
Design.1.D
```

3.1 Evaluate the fractional factorial design

```{r}
# Change factor variables to numerical variables
Design.1.D.num <- sapply(Design.1.D, as.numeric)

# Calculate the correlation matrix among different factors
cor(Design.1.D.num)
```

3.2 Calculate the A-efficiency and D-efficiency
```{r}
# Run the R script "CE_D&A Efficiency-function.R"
# Please change the directory inside of the parentheses of r"()" 
# based on the location of the file "CE_D&A Efficiency-function.R" in your own computer
source(r"(/Users/surajgurung/Library/CloudStorage/Dropbox-UFL/Shared with Suraj Gurung/HCM_Research project/CE_D&A Efficiency.R)") ##This formula is necessary

# Calculate the A-efficiency and D-efficiency using D.A.eff function 
# that is defined in CE_D&A Efficiency-function.R 
D.A.eff(Design.1.D.num)
```


# Using the CE design 

```{r}
rm(list = ls()) # Clear space in R environment
if (!require("idefix")) install.packages("idefix")
library("idefix")
# Set seed to a random number to guarantee the following code generates
# the exactly same results in different machines and different time
set.seed(123)
```

## Note that Price should be used as categorical variable when design the CE. Otherwise only 2 levels of price will be used.

• $design: A numeric matrix wich contains an efficient design. 
• $error: Numeric value indicating the D-error of the design.
• $inf.error: Numeric value indicating the percentage of draws for which the D-error was Inf. (It is not relevant for D-optimal design)
• $probs: Numeric matrix containing the probabilities of each alternative in each choice set.


```{r}
cs <- Profiles(
  
  # The products have 5 attributes and each attribute has 3 levels
  lvls = c(4, 4, 3, 3),
  
  # First 4 attributes are categorical variables and code them using the dummy coding
  # The price attribute is treated as a categorical variable
  coding = c("D", "D", "D", "D"),
  
  # This argument is required if we include a continuous variable in the model
  # Otherwise, we should not include the argument
  # Here, the continuous variable is price and its levels are 10.99, 13.99, 16.99, 19.99
  #c.lvls = list(
  #  c(10.99, 13.99, 16.99, 19.99)
  #)
)

D <- Modfed(
  
  # Generate the design by searching the candidate choice profiles. 
  # The candidate choice profiles are saved in an object named "cs"
  cand.set = cs,
  
  # Set the number of final choice sets as 11
  n.sets = 11,
  
  # Set the number of choice alternatives (i.e., options) in each choice set as 3,
  # There are 2 experimented designed choice alternatives and 1 none options
  n.alts = 3,
  
  # Set TRUE if we want to include a none option in each choice set.
  no.choice = TRUE,
  
  # Not include alternative specific constants (ASCs) for 
  # two experimental designed options (the first two 0s)
  # Include ASCs for the none option (The last 1)
  alt.cte = c(0, 0, 1),
  
  # Set the priors of parameter values in the model
  # The first matrix is for ASCs, 
  # The second matrix is for parameters of attribute levels
  par.draws = list(
    
    # Set the prior for ASC of none option as 0
    matrix(c(0), ncol = 1),
    
    # Set the prior for parameters of all attribute levels as 0 
    # Each first 4 attributes has 3 levels and we use the first level as the 
    # base level, so there are 2*4=8 parameters
    # The last price attributes is a continuous variable, so there is only 1 parameter
    # In total, there are 2+2+2+2+1=9 parameters
    matrix(c(rep(0, 3), rep(0, 3), rep(0, 2), rep(0, 2)), ncol = 3+3+2+2)
  ),
  
  # The following argument is optional
  
  # The maximum number allowed interations to find the optimum. The default is Inf
  max.iter = 100,
  
  # A logical value indicating whether only the best design should be returned. 
  # The default is TRUE
  best = TRUE,
  
  # A numeric value indicating the number of random start designs to use. 
  # The default is 12
  n.start = 12,
  
  # Logical value indicating whether computations should be done over multiple cores. 
  # The default is TRUE.
  parallel = TRUE
)

D
```

# Decode the design matrix into a readable choice design

```{r}
# Use the Decode function to decode the design matrix, make it more readable,
# and save the results as an object named "Design"
#### Decode the design matrix ####==============================================
Design <- Decode(
  
  # The design matrix is saved in an element named "design" inside
  # the object "D" generated from the last step
  des = D$design,
  
  # The number of choice alternatives (i.e., options) in each choice set is 3, 
  # i.e., 2 experimented designed choice alternatives and 1 none options
  n.alts = 3,
  
  # The none option in each choice set is the 3rd option 
  no.choice = 3,
  
  # Not include alternative specific constants (ASCs) for 
  # two experimental designed options (the first two 0s)
  # Include ASCs for the none option (The last 1)
  alt.cte = c(0, 0, 1),
  
  # Set up the level names for each attribute
  lvl.names = list(
    c("$10.99", "$13.99", "$16.99", "$19.99"), # Price
    c("1320Cal", "1520Cal", "1720Cal", "1920Cal"), # Calorie
    c("Regular Beef", "Plant-based beef", "USDA Certified Low Carbon Beef"), # Protein Source
    c("Home Kitchen", "Chain Restaurant", "Local Restuurant") # Food Outle
  ),
  
  # First 4 attributes are categorical variables and code them using the dummy coding
  # The price attribute is treated as a continuous variable
  coding = c("D", "D", "D", "D"),
  
  # This argument is required if we include a continuous variable in the model
  # Otherwise, we should not include the argument
  # In the example, the continuous variable is price and its levels are 1.99, 2.99 and 3.99 
  
  #c.lvls = list(
  #  c("$10.99", "$13.99", "$16.99", "$19.99")
  #)
  
)

# Using the head function to view the object Design
Design
```






